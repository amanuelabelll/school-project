<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>School of Redemption</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1B3C53;
      --secondary: #456882;
      --accent: #D2C1B6;
      --background: #F9F3EF;
      --light: #ffffff;
      --dark: #121212;
      --success: #4CAF50;
      --warning: #FFC107;
      --danger: #F44336;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--background);
      color: var(--primary);
      transition: all 0.3s ease-in-out;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .dark-mode {
      background-color: var(--dark);
      color: var(--light);
    }
    .dark-mode .container {
      background: #1E1E1E;
      color: var(--light);
    }
    .dark-mode .card {
      background: #2D2D2D;
    }
    .dark-mode .input-field {
      background: #333;
      color: white;
      border-color: #555;
    }
    header {
      background-color: var(--primary);
      color: white;
      padding: 1.2rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    header h1 { margin: 0; }
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      flex: 1;
    }
    .btn {
      background: var(--secondary);
      color: white;
      padding: 0.6rem 1.3rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn:hover { background: var(--primary); transform: translateY(-2px); }
    .btn-success { background: var(--success); }
    .btn-warning { background: var(--warning); color: var(--dark); }
    .btn-danger { background: var(--danger); }
    .btn-sm { padding: 0.3rem 0.8rem; font-size: 0.9rem; }
    .flex-center {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dashboard, .hidden { display: none; }
    .input-field {
      padding: 0.8rem;
      margin: 0.5rem 0;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    .card {
      background: var(--background);
      padding: 1.5rem;
      margin: 1rem 0;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: transform 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .admin-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .log-table th, .log-table td {
      padding: 0.8em;
      border: 1px solid #ddd;
      text-align: left;
    }
    .log-table {
      width: 100%;
      margin-top: 1em;
      border-collapse: collapse;
    }
    .log-table tr:nth-child(even) {
      background-color: rgba(0,0,0,0.03);
    }
    .dark-mode .log-table tr:nth-child(even) {
      background-color: rgba(255,255,255,0.05);
    }
    .badge {
      background-color: var(--accent);
      color: var(--primary);
      padding: 0.3em 0.8em;
      border-radius: 6px;
      font-size: 0.8em;
      font-weight: bold;
    }
    .badge-success { background: var(--success); color: white; }
    .badge-warning { background: var(--warning); color: var(--dark); }
    .badge-danger { background: var(--danger); color: white; }
    .section-title {
      font-size: 1.8em;
      margin-bottom: 1em;
      color: var(--secondary);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.5rem;
    }
    footer {
      text-align: center;
      padding: 1.5rem;
      margin-top: auto;
      background: var(--primary);
      color: white;
      border-top: 4px solid var(--accent);
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin: 2rem 0;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background-color: var(--background);
      margin: 5% auto;
      padding: 2rem;
      border-radius: 10px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      position: relative;
    }
    .dark-mode .modal-content {
      background-color: #2D2D2D;
    }
    .close-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 1.5rem;
    }
    .tab {
      padding: 0.8rem 1.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      border-bottom: 3px solid var(--secondary);
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .search-box {
      padding: 0.8rem;
      width: 300px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 1.5rem;
    }
    .dark-mode .search-box {
      background: #333;
      color: white;
      border-color: #555;
    }
    .feedback-card {
      background: rgba(210, 193, 182, 0.2);
      border-left: 4px solid var(--accent);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(70, 104, 130, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(70, 104, 130, 0); }
      100% { box-shadow: 0 0 0 0 rgba(70, 104, 130, 0); }
    }
    .editable {
      cursor: pointer;
      border-bottom: 1px dashed #999;
    }
    .editable:hover {
      background-color: rgba(210, 193, 182, 0.3);
    }
    .print-only {
      display: none;
    }
    .news-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    .news-card {
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .news-card:hover {
      transform: translateY(-5px);
    }
    .news-image {
      height: 180px;
      background-size: cover;
      background-position: center;
    }
    .news-content {
      padding: 1.5rem;
      background: white;
    }
    .dark-mode .news-content {
      background: #2D2D2D;
    }
    .news-date {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .dark-mode .news-date {
      color: #aaa;
    }
    .news-title {
      font-size: 1.2rem;
      margin-bottom: 0.8rem;
      color: var(--secondary);
    }
    .events-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    .event-card {
      padding: 1.5rem;
      border-radius: 10px;
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-left: 4px solid var(--accent);
    }
    .dark-mode .event-card {
      background: #2D2D2D;
    }
    .event-date {
      font-weight: bold;
      color: var(--secondary);
      margin-bottom: 0.5rem;
    }
    .event-title {
      font-size: 1.1rem;
      margin-bottom: 0.8rem;
    }
    .event-desc {
      font-size: 0.9rem;
      color: #666;
    }
    .dark-mode .event-desc {
      color: #aaa;
    }
    .home-hero {
      text-align: center;
      padding: 3rem 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-radius: 10px;
      margin-bottom: 2rem;
    }
    .home-hero h2 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    .home-hero p {
      font-size: 1.2rem;
      max-width: 800px;
      margin: 0 auto 2rem;
    }
    .class-checkbox-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .class-checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.3rem;
      border-radius: 4px;
      background: rgba(210, 193, 182, 0.2);
    }
    @media print {
      .no-print {
        display: none !important;
      }
      .print-only {
        display: block;
      }
      body {
        background: white !important;
        color: black !important;
      }
      .container {
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
      }
    }
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
        margin: 1rem auto;
      }
      .admin-tabs {
        flex-direction: column;
      }
      .modal-content {
        width: 95%;
        margin: 2% auto;
      }
      .news-container {
        grid-template-columns: 1fr;
      }
      .events-container {
        grid-template-columns: 1fr;
      }
      .class-checkbox-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (max-width: 480px) {
      .class-checkbox-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>School of Redemption</h1>
    <div>
      <button class="btn" onclick="toggleDarkMode()"><i class="fas fa-adjust"></i> Toggle Dark Mode</button>
      <span id="currentUser" style="margin-left: 1rem; display: none;"></span>
    </div>
  </header>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
      <h2 class="section-title">Login</h2>
      <div class="tabs">
        <div class="tab active" onclick="switchTab('student')">Student</div>
        <div class="tab" onclick="switchTab('teacher')">Teacher</div>
        <div class="tab" onclick="switchTab('admin')">Admin</div>
      </div>
      
      <div id="student-tab" class="tab-content active">
        <input type="text" id="studentUsername" class="input-field" placeholder="Username">
        <input type="password" id="studentPassword" class="input-field" placeholder="Password">
        <button class="btn" onclick="loginUser('student')"><i class="fas fa-sign-in-alt"></i> Login</button>
      </div>
      
      <div id="teacher-tab" class="tab-content">
        <input type="text" id="teacherUsername" class="input-field" placeholder="Username">
        <input type="password" id="teacherPassword" class="input-field" placeholder="Password">
        <button class="btn" onclick="loginUser('teacher')"><i class="fas fa-sign-in-alt"></i> Login</button>
      </div>
      
      <div id="admin-tab" class="tab-content">
        <input type="text" id="adminUsername" class="input-field" placeholder="Username">
        <input type="password" id="adminPassword" class="input-field" placeholder="Password">
        <button class="btn" onclick="loginUser('admin')"><i class="fas fa-sign-in-alt"></i> Login</button>
      </div>
    </div>
  </div>

  <!-- Home Screen -->
  <div class="container" id="home">
    <div class="home-hero">
      <h2>Welcome to School of Redemption</h2>
      <p>Empowering students through quality education and character development since 1995</p>
      <div class="flex-center">
        <button class="btn pulse" onclick="openModal('loginModal', 'student')"><i class="fas fa-user-graduate"></i> Student Login</button>
        <button class="btn pulse" onclick="openModal('loginModal', 'teacher')"><i class="fas fa-chalkboard-teacher"></i> Teacher Login</button>
        <button class="btn pulse" onclick="openModal('loginModal', 'admin')"><i class="fas fa-user-shield"></i> Admin Login</button>
      </div>
    </div>

    <h2 class="section-title">Latest News</h2>
    <div class="news-container">
      <div class="news-card">
        <div class="news-image" style="background-image: url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60');"></div>
        <div class="news-content">
          <div class="news-date">June 15, 2025</div>
          <h3 class="news-title">Annual Science Fair Winners Announced</h3>
          <p>Our students showcased incredible projects at this year's science fair. Congratulations to all participants!</p>
        </div>
      </div>
      <div class="news-card">
        <div class="news-image" style="background-image: url('https://images.unsplash.com/photo-1541178735493-479c1a27ed24?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60');"></div>
        <div class="news-content">
          <div class="news-date">May 28, 2025</div>
          <h3 class="news-title">New Computer Lab Facility Opened</h3>
          <p>The school has inaugurated a state-of-the-art computer lab with 50 new workstations and modern equipment.</p>
        </div>
      </div>
      <div class="news-card">
        <div class="news-image" style="background-image: url('https://images.unsplash.com/photo-1546410531-bb4caa6b424d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60');"></div>
        <div class="news-content">
          <div class="news-date">May 10, 2025</div>
          <h3 class="news-title">School Ranked #1 in District</h3>
          <p>For the third consecutive year, our school has been ranked first in academic performance in the district.</p>
        </div>
      </div>
    </div>

    <h2 class="section-title">Upcoming Events</h2>
    <div class="events-container">
      <div class="event-card">
        <div class="event-date">July 25, 2025</div>
        <h3 class="event-title">Parent-Teacher Meeting</h3>
        <p class="event-desc">Quarterly meeting to discuss student progress. All parents are encouraged to attend.</p>
      </div>
      <div class="event-card">
        <div class="event-date">August 5-9, 2025</div>
        <h3 class="event-title">Sports Week</h3>
        <p class="event-desc">Annual inter-class sports competition featuring athletics, football, and basketball.</p>
      </div>
      <div class="event-card">
        <div class="event-date">September 1, 2025</div>
        <h3 class="event-title">New Academic Year Begins</h3>
        <p class="event-desc">First day of the 2025-2026 academic year for all grades.</p>
      </div>
    </div>

    <h2 class="section-title">Recent Events</h2>
    <div class="events-container">
      <div class="event-card">
        <div class="event-date">June 30, 2025</div>
        <h3 class="event-title">Graduation Ceremony</h3>
        <p class="event-desc">Class of 2025 celebrated their graduation with a memorable ceremony.</p>
      </div>
      <div class="event-card">
        <div class="event-date">June 10, 2025</div>
        <h3 class="event-title">Cultural Day</h3>
        <p class="event-desc">Students showcased diverse cultural performances and traditional foods.</p>
      </div>
      <div class="event-card">
        <div class="event-date">May 15, 2025</div>
        <h3 class="event-title">Career Guidance Seminar</h3>
        <p class="event-desc">Industry professionals shared insights about various career paths.</p>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="container dashboard" id="dashboard">
    <div class="flex-between">
      <h2 id="dashboardTitle">Dashboard</h2>
      <div>
        <button class="btn no-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
        <button class="btn no-print" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
    <div id="dashboardContent"></div>
  </div>

  <!-- Admin Modals -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('addUserModal')">&times;</span>
      <h2 class="section-title">Add New User</h2>
      <select id="newUserRole" class="input-field" onchange="toggleUserFields()">
        <option value="student">Student</option>
        <option value="teacher">Teacher</option>
      </select>
      <input type="text" id="newUsername" class="input-field" placeholder="Username">
      <input type="password" id="newPassword" class="input-field" placeholder="Password">
      <input type="text" id="newFullName" class="input-field" placeholder="Full Name">
      
      <div id="studentFields">
        <input type="number" id="newGrade" class="input-field" placeholder="Grade" min="1" max="12">
        <div class="subject-inputs">
          <h4>Subjects & Initial Marks</h4>
          <div class="flex-between">
            <input type="text" class="input-field subject-name" placeholder="Subject" style="width: 48%;">
            <input type="number" class="input-field subject-mark" placeholder="Mark (0-100)" min="0" max="100" style="width: 48%;">
          </div>
        </div>
        <button class="btn btn-sm" onclick="addSubjectField()"><i class="fas fa-plus"></i> Add Subject</button>
      </div>
      
      <div id="teacherFields" style="display: none;">
        <input type="text" id="newSubject" class="input-field" placeholder="Subject">
        <div class="class-assignment">
          <h4>Assign Classes (Grades)</h4>
          <div class="class-checkbox-container">
            ${Array.from({length: 12}, (_, i) => i + 1).map(grade => `
              <label class="class-checkbox-label">
                <input type="checkbox" value="${grade}" class="class-checkbox"> Grade ${grade}
              </label>
            `).join('')}
          </div>
        </div>
      </div>
      
      <button class="btn btn-success" onclick="addNewUser()"><i class="fas fa-save"></i> Save User</button>
    </div>
  </div>

  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('editUserModal')">&times;</span>
      <h2 class="section-title">Edit User</h2>
      <div id="editUserContent"></div>
    </div>
  </div>

  <div id="backupModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('backupModal')">&times;</span>
      <h2 class="section-title">System Backup</h2>
      <div class="tabs">
        <div class="tab active" onclick="switchBackupTab('export')">Export Data</div>
        <div class="tab" onclick="switchBackupTab('import')">Import Data</div>
      </div>
      
      <div id="export-tab" class="tab-content active">
        <p>Export all system data as a JSON file:</p>
        <button class="btn" onclick="exportData()"><i class="fas fa-download"></i> Export Data</button>
      </div>
      
      <div id="import-tab" class="tab-content">
        <p>Import system data from a JSON file:</p>
        <input type="file" id="importFile" class="input-field">
        <button class="btn" onclick="importData()"><i class="fas fa-upload"></i> Import Data</button>
      </div>
    </div>
  </div>

  <footer>
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 2rem;">
        <div>
          <h3>School of Redemption</h3>
          <p>123 Education Street<br>Addis Ababa, Ethiopia</p>
          <p><i class="fas fa-phone"></i> +251 123 456 789</p>
          <p><i class="fas fa-envelope"></i> info@schoolofredemption.edu</p>
        </div>
        <div>
          <h3>Quick Links</h3>
          <ul style="list-style: none; padding: 0;">
            <li><a href="#" style="color: white; text-decoration: none;">Home</a></li>
            <li><a href="#" style="color: white; text-decoration: none;">Admissions</a></li>
            <li><a href="#" style="color: white; text-decoration: none;">Academics</a></li>
            <li><a href="#" style="color: white; text-decoration: none;">Contact Us</a></li>
          </ul>
        </div>
        <div>
          <h3>Follow Us</h3>
          <div style="display: flex; gap: 1rem; font-size: 1.5rem;">
            <a href="#" style="color: white;"><i class="fab fa-facebook"></i></a>
            <a href="#" style="color: white;"><i class="fab fa-twitter"></i></a>
            <a href="#" style="color: white;"><i class="fab fa-instagram"></i></a>
            <a href="#" style="color: white;"><i class="fab fa-youtube"></i></a>
          </div>
        </div>
      </div>
      <hr style="border-color: rgba(255,255,255,0.2); margin: 1.5rem 0;">
      <p style="text-align: center;">&copy; 2025 School of Redemption â€” All rights reserved. | Designed with Amanuel Abel</p>
    </div>
  </footer>

  <script>
    // Initialize system data
    let systemUsers = {
      students: [
        { 
          username: "maria", 
          password: "123", 
          fullName: "Maria Solomon", 
          grade: 9, 
          marks: { Math: 88, Science: 92, English: 85 }, 
          attendance: { Math: "94%", Science: "95%", English: "96%" },
          remarks: { Math: "Excellent work", Science: "Very engaged", English: "Needs more participation" }
        },
        { 
          username: "john", 
          password: "456", 
          fullName: "John Kebede", 
          grade: 10, 
          marks: { Math: 75, Science: 80, English: 77 }, 
          attendance: { Math: "89%", Science: "91%", English: "88%" },
          remarks: { Math: "Needs to practice more", Science: "Good effort", English: "Improving steadily" }
        }
      ],
      teachers: [
        { 
          username: "tsegaye", 
          password: "eng123", 
          fullName: "Mr. Tsegaye", 
          subject: "English",
          assignedClasses: ["9", "10"]
        },
        { 
          username: "meaza", 
          password: "math123", 
          fullName: "Ms. Meaza", 
          subject: "Math",
          assignedClasses: ["9", "10"]
        },
        { 
          username: "biruk", 
          password: "sci123", 
          fullName: "Mr. Biruk", 
          subject: "Science",
          assignedClasses: ["9", "10"]
        }
      ],
      admin: { 
        username: "admin", 
        password: "admin123" 
      },
      logs: [],
      settings: {
        darkMode: false
      }
    };

    // Current user state
    let currentUser = null;
    let currentRole = null;

    // Load data from localStorage
    function loadData() {
      const savedData = localStorage.getItem("schoolData");
      if (savedData) {
        systemUsers = JSON.parse(savedData);
      }
      
      // Apply dark mode if enabled
      if (systemUsers.settings.darkMode) {
        document.body.classList.add("dark-mode");
      }
    }

    // Save data to localStorage
    function saveData() {
      systemUsers.settings.darkMode = document.body.classList.contains("dark-mode");
      localStorage.setItem("schoolData", JSON.stringify(systemUsers));
    }

    // Initialize the app
    function init() {
      loadData();
      
      // Check if user is already logged in (for page refresh)
      const savedUser = sessionStorage.getItem("currentUser");
      const savedRole = sessionStorage.getItem("currentRole");
      
      if (savedUser && savedRole) {
        currentUser = savedUser;
        currentRole = savedRole;
        showDashboard(currentRole, currentUser);
      }
    }

    // Modal functions
    function openModal(modalId, role = null) {
      document.getElementById(modalId).style.display = "block";
      
      if (role) {
        switchTab(role);
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    function switchTab(role) {
      // Update tabs
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
      
      // Activate selected tab
      const tabs = document.querySelector(".tabs").children;
      for (let i = 0; i < tabs.length; i++) {
        if (tabs[i].textContent.toLowerCase().includes(role)) {
          tabs[i].classList.add("active");
          document.getElementById(`${role}-tab`).classList.add("active");
          break;
        }
      }
    }

    function switchBackupTab(tab) {
      document.querySelectorAll("#backupModal .tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll("#backupModal .tab-content").forEach(c => c.classList.remove("active"));
      
      document.querySelector(`#backupModal .tab:contains('${tab === 'export' ? 'Export' : 'Import'}')`).classList.add("active");
      document.getElementById(`${tab}-tab`).classList.add("active");
    }

    // Login functions
    function loginUser(role) {
      let username, password;
      
      if (role === 'student') {
        username = document.getElementById("studentUsername").value;
        password = document.getElementById("studentPassword").value;
      } else if (role === 'teacher') {
        username = document.getElementById("teacherUsername").value;
        password = document.getElementById("teacherPassword").value;
      } else if (role === 'admin') {
        username = document.getElementById("adminUsername").value;
        password = document.getElementById("adminPassword").value;
      }
      
      if (!username || !password) {
        alert("Please enter both username and password");
        return;
      }

      const time = new Date().toLocaleString();
      let ip = "N/A";
      
      // Simulate IP detection (in a real app, this would come from the server)
      if (navigator.onLine) {
        ip = "192.168." + Math.floor(Math.random() * 255) + "." + Math.floor(Math.random() * 255);
      }
      
      if (role === 'admin' && username === systemUsers.admin.username && password === systemUsers.admin.password) {
        systemUsers.logs.push({ user: username, role, time, ip, action: "login" });
        currentUser = username;
        currentRole = role;
        sessionStorage.setItem("currentUser", username);
        sessionStorage.setItem("currentRole", role);
        closeModal("loginModal");
        showDashboard(role, username);
        saveData();
      } else if (role === 'student') {
        const student = systemUsers.students.find(s => s.username === username && s.password === password);
        if (student) {
          systemUsers.logs.push({ user: username, role, time, ip, action: "login" });
          currentUser = username;
          currentRole = role;
          sessionStorage.setItem("currentUser", username);
          sessionStorage.setItem("currentRole", role);
          closeModal("loginModal");
          showDashboard(role, username);
          saveData();
        } else {
          alert("Invalid student credentials");
        }
      } else if (role === 'teacher') {
        const teacher = systemUsers.teachers.find(t => t.username === username && t.password === password);
        if (teacher) {
          systemUsers.logs.push({ user: username, role, time, ip, action: "login" });
          currentUser = username;
          currentRole = role;
          sessionStorage.setItem("currentUser", username);
          sessionStorage.setItem("currentRole", role);
          closeModal("loginModal");
          showDashboard(role, username);
          saveData();
        } else {
          alert("Invalid teacher credentials");
        }
      } else {
        alert("Invalid credentials");
      }
    }

    function logout() {
      const time = new Date().toLocaleString();
      if (currentUser && currentRole) {
        systemUsers.logs.push({ user: currentUser, role: currentRole, time, action: "logout" });
        saveData();
      }
      
      sessionStorage.removeItem("currentUser");
      sessionStorage.removeItem("currentRole");
      currentUser = null;
      currentRole = null;
      location.reload();
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      saveData();
    }

    // Dashboard functions
    function showDashboard(role, username) {
      document.getElementById("home").style.display = "none";
      const dash = document.getElementById("dashboard");
      dash.style.display = "block";
      document.getElementById("dashboardTitle").textContent = `${role.charAt(0).toUpperCase() + role.slice(1)} Dashboard`;
      document.getElementById("currentUser").textContent = `Logged in as: ${username}`;
      document.getElementById("currentUser").style.display = "inline";
      
      const content = document.getElementById("dashboardContent");
      content.innerHTML = '';
      
      if (role === 'student') {
        showStudentDashboard(username);
      } else if (role === 'teacher') {
        showTeacherDashboard(username);
      } else if (role === 'admin') {
        showAdminDashboard();
      }
    }

    function showStudentDashboard(username) {
      const student = systemUsers.students.find(s => s.username === username);
      if (!student) return;
      
      const content = document.getElementById("dashboardContent");
      
      // Performance analysis
      const feedback = analyzePerformance(student);
      
      content.innerHTML = `
        <div class="card">
          <h3>${student.fullName} <span class="badge">Grade ${student.grade}</span></h3>
          <p><i class="fas fa-envelope"></i> ${student.username}@school.edu</p>
        </div>
        
        <div class="card feedback-card">
          <h3><i class="fas fa-lightbulb"></i> Performance Feedback</h3>
          <p>${feedback.overall}</p>
          <ul>
            ${feedback.details.map(item => `<li>${item}</li>`).join('')}
          </ul>
        </div>
        
        <div class="card">
          <h3><i class="fas fa-chart-line"></i> Academic Performance</h3>
          <div class="chart-container">
            <canvas id="marksChart"></canvas>
          </div>
        </div>
        
        <div class="flex-between" style="gap: 1rem;">
          <div class="card" style="flex: 1;">
            <h3><i class="fas fa-check-circle"></i> Marks</h3>
            <table class="log-table">
              <tr><th>Subject</th><th>Mark</th><th>Remark</th></tr>
              ${Object.entries(student.marks).map(([sub, mark]) => `
                <tr>
                  <td>${sub}</td>
                  <td>${mark} <span class="badge ${getMarkBadgeClass(mark)}">${getMarkRating(mark)}</span></td>
                  <td>${student.remarks?.[sub] || 'No remark'}</td>
                </tr>
              `).join('')}
            </table>
          </div>
          
          <div class="card" style="flex: 1;">
            <h3><i class="fas fa-calendar-check"></i> Attendance</h3>
            <table class="log-table">
              <tr><th>Subject</th><th>Attendance</th></tr>
              ${Object.entries(student.attendance).map(([sub, att]) => `
                <tr>
                  <td>${sub}</td>
                  <td>${att} <span class="badge ${getAttendanceBadgeClass(att)}">${getAttendanceRating(att)}</span></td>
                </tr>
              `).join('')}
            </table>
          </div>
        </div>
        
        <div class="card print-only">
          <h3>Official Report Card</h3>
          <p>Student: ${student.fullName}</p>
          <p>Grade: ${student.grade}</p>
          <p>Date: ${new Date().toLocaleDateString()}</p>
          <table class="log-table">
            <tr><th>Subject</th><th>Mark</th><th>Attendance</th><th>Remark</th></tr>
            ${Object.keys(student.marks).map(sub => `
              <tr>
                <td>${sub}</td>
                <td>${student.marks[sub]}</td>
                <td>${student.attendance[sub]}</td>
                <td>${student.remarks?.[sub] || 'No remark'}</td>
              </tr>
            `).join('')}
          </table>
          <p style="margin-top: 2rem;">Principal's Signature: ________________________</p>
        </div>
      `;
      
      // Render charts
      renderStudentCharts(student);
    }

    function renderStudentCharts(student) {
      // Marks bar chart
      const marksCtx = document.getElementById('marksChart').getContext('2d');
      new Chart(marksCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(student.marks),
          datasets: [{
            label: 'Marks',
            data: Object.values(student.marks),
            backgroundColor: [
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 99, 132, 0.7)',
              'rgba(75, 192, 192, 0.7)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)',
              'rgba(75, 192, 192, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function showTeacherDashboard(username) {
      const teacher = systemUsers.teachers.find(t => t.username === username);
      if (!teacher) return;
      
      const content = document.getElementById("dashboardContent");
      
      // Get students assigned to this teacher's classes
      const assignedStudents = systemUsers.students.filter(student => 
        teacher.assignedClasses.includes(student.grade.toString())
      );
      
      content.innerHTML = `
        <div class="card">
          <h3>Welcome, ${teacher.fullName} <span class="badge">${teacher.subject} Teacher</span></h3>
          <p>Assigned classes: Grade ${teacher.assignedClasses.join(', ')}</p>
        </div>
        
        <div class="card">
          <div class="flex-between">
            <h3><i class="fas fa-users"></i> Your Students</h3>
            <input type="text" id="studentSearch" class="search-box no-print" placeholder="Search students..." oninput="filterStudents()">
          </div>
          
          <div id="studentsList">
            ${assignedStudents.map(student => `
              <div class="card student-card" data-name="${student.fullName.toLowerCase()}">
                <div class="flex-between">
                  <h4>${student.fullName} <span class="badge">Grade ${student.grade}</span></h4>
                  <div>
                    <span class="badge ${getMarkBadgeClass(student.marks[teacher.subject] || 0)}">
                      ${teacher.subject}: ${student.marks[teacher.subject] || '-'}
                    </span>
                    <span class="badge ${getAttendanceBadgeClass(student.attendance[teacher.subject] || '0%')}">
                      Attendance: ${student.attendance[teacher.subject] || '-'}
                    </span>
                  </div>
                </div>
                
                <div class="flex-between" style="margin-top: 1rem;">
                  <div>
                    <label>Mark:</label>
                    <input type="number" 
                           class="input-field editable-mark" 
                           value="${student.marks[teacher.subject] || ''}" 
                           min="0" max="100"
                           data-username="${student.username}"
                           data-subject="${teacher.subject}"
                           onchange="updateStudentMark('${student.username}', '${teacher.subject}', this.value)">
                  </div>
                  <div>
                    <label>Attendance:</label>
                    <input type="text" 
                           class="input-field editable-attendance" 
                           value="${student.attendance[teacher.subject] || ''}" 
                           data-username="${student.username}"
                           data-subject="${teacher.subject}"
                           onchange="updateStudentAttendance('${student.username}', '${teacher.subject}', this.value)">
                  </div>
                </div>
                
                <div style="margin-top: 1rem;">
                  <label>Remarks:</label>
                  <textarea class="input-field editable-remark" 
                            data-username="${student.username}"
                            data-subject="${teacher.subject}"
                            onchange="updateStudentRemark('${student.username}', '${teacher.subject}', this.value)">${student.remarks?.[teacher.subject] || ''}</textarea>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function filterStudents() {
      const searchTerm = document.getElementById("studentSearch").value.toLowerCase();
      const studentCards = document.querySelectorAll(".student-card");
      
      studentCards.forEach(card => {
        const studentName = card.getAttribute("data-name");
        if (studentName.includes(searchTerm)) {
          card.style.display = "block";
        } else {
          card.style.display = "none";
        }
      });
    }

    function updateStudentMark(username, subject, mark) {
      const student = systemUsers.students.find(s => s.username === username);
      if (student) {
        student.marks[subject] = parseInt(mark);
        saveData();
        
        // Update badge color
        const badge = document.querySelector(`.editable-mark[data-username="${username}"][data-subject="${subject}"]`)
                      .parentElement.querySelector(".badge");
        if (badge) {
          badge.className = `badge ${getMarkBadgeClass(mark)}`;
          badge.textContent = `${subject}: ${mark}`;
        }
      }
    }

    function updateStudentAttendance(username, subject, attendance) {
      const student = systemUsers.students.find(s => s.username === username);
      if (student) {
        student.attendance[subject] = attendance;
        saveData();
        
        // Update badge color
        const badge = document.querySelector(`.editable-attendance[data-username="${username}"][data-subject="${subject}"]`)
                      .parentElement.querySelector(".badge:nth-child(2)");
        if (badge) {
          badge.className = `badge ${getAttendanceBadgeClass(attendance)}`;
          badge.textContent = `Attendance: ${attendance}`;
        }
      }
    }

    function updateStudentRemark(username, subject, remark) {
      const student = systemUsers.students.find(s => s.username === username);
      if (student) {
        if (!student.remarks) student.remarks = {};
        student.remarks[subject] = remark;
        saveData();
      }
    }

    function showAdminDashboard() {
      const content = document.getElementById("dashboardContent");
      
      content.innerHTML = `
        <div class="card">
          <h3>Welcome, Admin</h3>
          <p>System overview and management tools:</p>
        </div>
        
        <div class="admin-tabs">
          <button class="btn" onclick="showUsersList()"><i class="fas fa-users"></i> Manage Users</button>
          <button class="btn" onclick="showLogs()"><i class="fas fa-history"></i> View Logs</button>
          <button class="btn" onclick="openModal('backupModal')"><i class="fas fa-database"></i> Backup/Restore</button>
          <button class="btn" onclick="showSystemStats()"><i class="fas fa-chart-pie"></i> System Stats</button>
        </div>
        
        <div id="adminDetails"></div>
      `;
      
      // Show users list by default
      showUsersList();
    }

    function showUsersList() {
      const content = document.getElementById("adminDetails");
      
      content.innerHTML = `
        <div class="card">
          <div class="flex-between">
            <h3><i class="fas fa-users-cog"></i> User Management</h3>
            <div>
              <button class="btn btn-success" onclick="openModal('addUserModal')"><i class="fas fa-plus"></i> Add User</button>
              <input type="text" id="userSearch" class="search-box" placeholder="Search users..." oninput="filterUsers()">
            </div>
          </div>
          
          <div class="tabs" style="margin-top: 1rem;">
            <div class="tab active" onclick="switchUserTab('students')">Students</div>
            <div class="tab" onclick="switchUserTab('teachers')">Teachers</div>
          </div>
          
          <div id="studentsTab" class="user-tab">
            <table class="log-table">
              <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Grade</th>
                <th>Subjects</th>
                <th>Actions</th>
              </tr>
              ${systemUsers.students.map(student => `
                <tr class="user-row" data-name="${student.fullName.toLowerCase()}">
                  <td>${student.fullName}</td>
                  <td>${student.username}</td>
                  <td>${student.grade}</td>
                  <td>${Object.keys(student.marks).join(', ')}</td>
                  <td>
                    <button class="btn btn-sm" onclick="editUser('student', '${student.username}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('student', '${student.username}')"><i class="fas fa-trash"></i> Delete</button>
                  </td>
                </tr>
              `).join('')}
            </table>
          </div>
          
          <div id="teachersTab" class="user-tab" style="display: none;">
            <table class="log-table">
              <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Subject</th>
                <th>Assigned Classes</th>
                <th>Actions</th>
              </tr>
              ${systemUsers.teachers.map(teacher => `
                <tr class="user-row" data-name="${teacher.fullName.toLowerCase()}">
                  <td>${teacher.fullName}</td>
                  <td>${teacher.username}</td>
                  <td>${teacher.subject}</td>
                  <td>Grade ${teacher.assignedClasses.join(', ')}</td>
                  <td>
                    <button class="btn btn-sm" onclick="editUser('teacher', '${teacher.username}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('teacher', '${teacher.username}')"><i class="fas fa-trash"></i> Delete</button>
                  </td>
                </tr>
              `).join('')}
            </table>
          </div>
        </div>
      `;
    }

    function switchUserTab(type) {
      document.querySelectorAll(".user-tab").forEach(tab => tab.style.display = "none");
      document.querySelectorAll(".admin-tabs .tab").forEach(tab => tab.classList.remove("active"));
      
      document.getElementById(`${type}Tab`).style.display = "block";
      document.querySelector(`.admin-tabs .tab:contains('${type === 'students' ? 'Students' : 'Teachers'}')`).classList.add("active");
    }

    function filterUsers() {
      const searchTerm = document.getElementById("userSearch").value.toLowerCase();
      const userRows = document.querySelectorAll(".user-row");
      
      userRows.forEach(row => {
        const userName = row.getAttribute("data-name");
        if (userName.includes(searchTerm)) {
          row.style.display = "table-row";
        } else {
          row.style.display = "none";
        }
      });
    }

    function showLogs() {
      const content = document.getElementById("adminDetails");
      
      content.innerHTML = `
        <div class="card">
          <h3><i class="fas fa-history"></i> System Logs</h3>
          <p>Recent system activities and access logs:</p>
          
          <table class="log-table">
            <tr>
              <th>Time</th>
              <th>User</th>
              <th>Role</th>
              <th>IP Address</th>
              <th>Action</th>
            </tr>
            ${systemUsers.logs.slice().reverse().map(log => `
              <tr>
                <td>${log.time}</td>
                <td>${log.user}</td>
                <td>${log.role}</td>
                <td>${log.ip || 'N/A'}</td>
                <td>${log.action}</td>
              </tr>
            `).join('')}
          </table>
        </div>
      `;
    }

    function showSystemStats() {
      const content = document.getElementById("adminDetails");
      
      // Calculate statistics
      const totalStudents = systemUsers.students.length;
      const totalTeachers = systemUsers.teachers.length;
      const totalLogins = systemUsers.logs.filter(log => log.action === 'login').length;
      
      // Calculate average marks
      let totalMarks = 0;
      let markCount = 0;
      systemUsers.students.forEach(student => {
        Object.values(student.marks).forEach(mark => {
          totalMarks += mark;
          markCount++;
        });
      });
      const averageMark = markCount > 0 ? (totalMarks / markCount).toFixed(1) : 0;
      
      content.innerHTML = `
        <div class="card">
          <h3><i class="fas fa-chart-pie"></i> System Statistics</h3>
          
          <div class="flex-between" style="gap: 1rem; margin-bottom: 1rem;">
            <div class="card" style="flex: 1;">
              <h4>Users</h4>
              <p>Students: ${totalStudents}</p>
              <p>Teachers: ${totalTeachers}</p>
            </div>
            
            <div class="card" style="flex: 1;">
              <h4>Activity</h4>
              <p>Total Logins: ${totalLogins}</p>
              <p>Average Mark: ${averageMark}</p>
            </div>
          </div>
          
          <div class="chart-container">
            <canvas id="userChart"></canvas>
          </div>
        </div>
      `;
      
      // Render chart
      const ctx = document.getElementById('userChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Students', 'Teachers'],
          datasets: [{
            data: [totalStudents, totalTeachers],
            backgroundColor: [
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 99, 132, 0.7)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // User management functions
    function toggleUserFields() {
      const role = document.getElementById("newUserRole").value;
      document.getElementById("studentFields").style.display = role === 'student' ? 'block' : 'none';
      document.getElementById("teacherFields").style.display = role === 'teacher' ? 'block' : 'none';
    }

    function addSubjectField() {
      const container = document.querySelector(".subject-inputs");
      const newField = document.createElement("div");
      newField.className = "flex-between";
      newField.style.marginTop = "0.5rem";
      newField.innerHTML = `
        <input type="text" class="input-field subject-name" placeholder="Subject" style="width: 48%;">
        <input type="number" class="input-field subject-mark" placeholder="Mark (0-100)" min="0" max="100" style="width: 48%;">
      `;
      container.appendChild(newField);
    }

    function addNewUser() {
      const role = document.getElementById("newUserRole").value;
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      const fullName = document.getElementById("newFullName").value;
      
      if (!username || !password || !fullName) {
        alert("Please fill all required fields");
        return;
      }
      
      if (role === 'student') {
        const grade = document.getElementById("newGrade").value;
        if (!grade) {
          alert("Please enter grade");
          return;
        }
        
        // Collect subjects and marks
        const subjectInputs = document.querySelectorAll(".subject-name");
        const markInputs = document.querySelectorAll(".subject-mark");
        
        const marks = {};
        for (let i = 0; i < subjectInputs.length; i++) {
          const subject = subjectInputs[i].value;
          const mark = markInputs[i].value;
          if (subject && mark) {
            marks[subject] = parseInt(mark);
          }
        }
        
        // Create attendance object with default values
        const attendance = {};
        Object.keys(marks).forEach(subject => {
          attendance[subject] = "90%";
        });
        
        const newStudent = {
          username,
          password,
          fullName,
          grade: parseInt(grade),
          marks,
          attendance,
          remarks: {}
        };
        
        systemUsers.students.push(newStudent);
      } else if (role === 'teacher') {
        const subject = document.getElementById("newSubject").value;
        if (!subject) {
          alert("Please enter subject");
          return;
        }
        
        // Get selected classes
        const classCheckboxes = document.querySelectorAll(".class-checkbox:checked");
        const assignedClasses = Array.from(classCheckboxes).map(cb => cb.value);
        
        const newTeacher = {
          username,
          password,
          fullName,
          subject,
          assignedClasses
        };
        
        systemUsers.teachers.push(newTeacher);
      }
      
      saveData();
      closeModal("addUserModal");
      showUsersList();
      
      // Reset form
      document.getElementById("newUsername").value = '';
      document.getElementById("newPassword").value = '';
      document.getElementById("newFullName").value = '';
      document.getElementById("newGrade").value = '';
      document.querySelectorAll(".subject-inputs div:not(:first-child)").forEach(el => el.remove());
      document.querySelector(".subject-name").value = '';
      document.querySelector(".subject-mark").value = '';
      document.getElementById("newSubject").value = '';
      document.querySelectorAll(".class-checkbox").forEach(cb => cb.checked = false);
    }

    function editUser(type, username) {
      let user;
      if (type === 'student') {
        user = systemUsers.students.find(s => s.username === username);
      } else if (type === 'teacher') {
        user = systemUsers.teachers.find(t => t.username === username);
      }
      
      if (!user) return;
      
      const content = document.getElementById("editUserContent");
      
      if (type === 'student') {
        content.innerHTML = `
          <h3>Edit Student: ${user.fullName}</h3>
          <input type="text" id="editFullName" class="input-field" value="${user.fullName}" placeholder="Full Name">
          <input type="text" id="editUsername" class="input-field" value="${user.username}" placeholder="Username">
          <input type="password" id="editPassword" class="input-field" value="${user.password}" placeholder="Password">
          <input type="number" id="editGrade" class="input-field" value="${user.grade}" placeholder="Grade" min="1" max="12">
          
          <h4 style="margin-top: 1rem;">Subjects & Marks</h4>
          <div id="editSubjects">
            ${Object.entries(user.marks).map(([sub, mark]) => `
              <div class="flex-between" style="margin-bottom: 0.5rem;">
                <input type="text" class="input-field" value="${sub}" style="width: 48%;">
                <input type="number" class="input-field" value="${mark}" min="0" max="100" style="width: 48%;">
              </div>
            `).join('')}
          </div>
          
          <button class="btn btn-sm" onclick="addEditSubjectField()"><i class="fas fa-plus"></i> Add Subject</button>
          
          <div style="margin-top: 1rem;">
            <button class="btn btn-success" onclick="saveUserChanges('student', '${username}')"><i class="fas fa-save"></i> Save Changes</button>
            <button class="btn" onclick="closeModal('editUserModal')">Cancel</button>
          </div>
        `;
      } else if (type === 'teacher') {
        content.innerHTML = `
          <h3>Edit Teacher: ${user.fullName}</h3>
          <input type="text" id="editFullName" class="input-field" value="${user.fullName}" placeholder="Full Name">
          <input type="text" id="editUsername" class="input-field" value="${user.username}" placeholder="Username">
          <input type="password" id="editPassword" class="input-field" value="${user.password}" placeholder="Password">
          <input type="text" id="editSubject" class="input-field" value="${user.subject}" placeholder="Subject">
          
          <h4 style="margin-top: 1rem;">Assigned Classes</h4>
          <div class="class-checkbox-container">
            ${Array.from({length: 12}, (_, i) => i + 1).map(grade => `
              <label class="class-checkbox-label">
                <input type="checkbox" value="${grade}" class="edit-class-checkbox" 
                  ${user.assignedClasses.includes(grade.toString()) ? 'checked' : ''}> 
                Grade ${grade}
              </label>
            `).join('')}
          </div>
          
          <div style="margin-top: 1rem;">
            <button class="btn btn-success" onclick="saveUserChanges('teacher', '${username}')"><i class="fas fa-save"></i> Save Changes</button>
            <button class="btn" onclick="closeModal('editUserModal')">Cancel</button>
          </div>
        `;
      }
      
      openModal("editUserModal");
    }

    function addEditSubjectField() {
      const container = document.getElementById("editSubjects");
      const newField = document.createElement("div");
      newField.className = "flex-between";
      newField.style.marginBottom = "0.5rem";
      newField.innerHTML = `
        <input type="text" class="input-field" placeholder="Subject" style="width: 48%;">
        <input type="number" class="input-field" placeholder="Mark (0-100)" min="0" max="100" style="width: 48%;">
      `;
      container.appendChild(newField);
    }

    function saveUserChanges(type, oldUsername) {
      const fullName = document.getElementById("editFullName").value;
      const username = document.getElementById("editUsername").value;
      const password = document.getElementById("editPassword").value;
      
      if (!fullName || !username || !password) {
        alert("Please fill all required fields");
        return;
      }
      
      if (type === 'student') {
        const grade = document.getElementById("editGrade").value;
        if (!grade) {
          alert("Please enter grade");
          return;
        }
        
        // Collect subjects and marks
        const subjectInputs = document.querySelectorAll("#editSubjects input[type='text']");
        const markInputs = document.querySelectorAll("#editSubjects input[type='number']");
        
        const marks = {};
        const attendance = {};
        for (let i = 0; i < subjectInputs.length; i++) {
          const subject = subjectInputs[i].value;
          const mark = markInputs[i].value;
          if (subject && mark) {
            marks[subject] = parseInt(mark);
            attendance[subject] = "90%"; // Default attendance
          }
        }
        
        // Find and update student
        const studentIndex = systemUsers.students.findIndex(s => s.username === oldUsername);
        if (studentIndex !== -1) {
          systemUsers.students[studentIndex] = {
            ...systemUsers.students[studentIndex],
            username,
            password,
            fullName,
            grade: parseInt(grade),
            marks,
            attendance
          };
        }
      } else if (type === 'teacher') {
        const subject = document.getElementById("editSubject").value;
        if (!subject) {
          alert("Please enter subject");
          return;
        }
        
        // Get selected classes
        const classCheckboxes = document.querySelectorAll(".edit-class-checkbox:checked");
        const assignedClasses = Array.from(classCheckboxes).map(cb => cb.value);
        
        // Find and update teacher
        const teacherIndex = systemUsers.teachers.findIndex(t => t.username === oldUsername);
        if (teacherIndex !== -1) {
          systemUsers.teachers[teacherIndex] = {
            ...systemUsers.teachers[teacherIndex],
            username,
            password,
            fullName,
            subject,
            assignedClasses
          };
        }
      }
      
      saveData();
      closeModal("editUserModal");
      showUsersList();
    }

    function deleteUser(type, username) {
      if (!confirm(`Are you sure you want to delete this ${type}?`)) return;
      
      if (type === 'student') {
        systemUsers.students = systemUsers.students.filter(s => s.username !== username);
      } else if (type === 'teacher') {
        systemUsers.teachers = systemUsers.teachers.filter(t => t.username !== username);
      }
      
      saveData();
      showUsersList();
    }

    // Backup functions
    function exportData() {
      const dataStr = JSON.stringify(systemUsers, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `school_data_${new Date().toISOString().slice(0,10)}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    function importData() {
      const fileInput = document.getElementById("importFile");
      const file = fileInput.files[0];
      
      if (!file) {
        alert("Please select a file to import");
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          // Basic validation
          if (!importedData.students || !importedData.teachers || !importedData.admin) {
            throw new Error("Invalid data format");
          }
          
          systemUsers = importedData;
          saveData();
          alert("Data imported successfully!");
          closeModal("backupModal");
          
          // Refresh if admin is viewing
          if (currentRole === 'admin') {
            showAdminDashboard();
          }
        } catch (error) {
          alert("Error importing data: " + error.message);
        }
      };
      reader.readAsText(file);
    }

    // Utility functions
    function getMarkBadgeClass(mark) {
      if (mark >= 85) return 'badge-success';
      if (mark >= 60) return 'badge-warning';
      return 'badge-danger';
    }

    function getMarkRating(mark) {
      if (mark >= 85) return 'Excellent';
      if (mark >= 75) return 'Good';
      if (mark >= 60) return 'Fair';
      return 'Poor';
    }

    function getAttendanceBadgeClass(attendance) {
      const percent = parseInt(attendance);
      if (percent >= 90) return 'badge-success';
      if (percent >= 75) return 'badge-warning';
      return 'badge-danger';
    }

    function getAttendanceRating(attendance) {
      const percent = parseInt(attendance);
      if (percent >= 90) return 'Excellent';
      if (percent >= 75) return 'Good';
      return 'Needs Improvement';
    }

    // Machine Learning Performance Analysis
    function analyzePerformance(student) {
      const subjects = Object.keys(student.marks);
      const marks = Object.values(student.marks);
      
      if (marks.length === 0) {
        return {
          overall: "No performance data available yet.",
          details: []
        };
      }
      
      // Calculate average
      const average = marks.reduce((sum, mark) => sum + mark, 0) / marks.length;
      
      // Find strongest and weakest subjects
      let strongest = { subject: "", mark: 0 };
      let weakest = { subject: "", mark: 100 };
      
      subjects.forEach((subject, i) => {
        if (marks[i] > strongest.mark) {
          strongest = { subject, mark: marks[i] };
        }
        if (marks[i] < weakest.mark) {
          weakest = { subject, mark: marks[i] };
        }
      });
      
      // Generate feedback
      let overall = "";
      const details = [];
      
      if (average >= 85) {
        overall = "Outstanding performance across all subjects!";
      } else if (average >= 75) {
        overall = "Good overall performance with room for improvement.";
      } else if (average >= 60) {
        overall = "Average performance - consider focusing more on studies.";
      } else {
        overall = "Performance needs significant improvement - please seek help.";
      }
      
      if (strongest.subject && strongest.mark >= 85) {
        details.push(`<strong>${strongest.subject}</strong> is your strongest subject (${strongest.mark}%). Keep up the good work!`);
      }
      
      if (weakest.subject && weakest.mark < 70) {
        details.push(`<strong>${weakest.subject}</strong> needs more attention (${weakest.mark}%). Consider extra practice or tutoring.`);
      }
      
      // Check for consistency
      const range = strongest.mark - weakest.mark;
      if (range > 30) {
        details.push("Your performance varies significantly between subjects. Try to balance your focus across all subjects.");
      } else if (range < 15) {
        details.push("Your performance is quite consistent across all subjects. This balanced approach is good!");
      }
      
      // Attendance check
      const attendanceValues = Object.values(student.attendance).map(a => parseInt(a));
      const avgAttendance = attendanceValues.reduce((sum, a) => sum + a, 0) / attendanceValues.length;
      
      if (avgAttendance < 80) {
        details.push(`Your attendance (${avgAttendance}%) is lower than recommended. Regular attendance is important for success.`);
      }
      
      return {
        overall,
        details
      };
    }

    // Initialize the app when page loads
    window.onload = init;
  </script>
</body>
</html>